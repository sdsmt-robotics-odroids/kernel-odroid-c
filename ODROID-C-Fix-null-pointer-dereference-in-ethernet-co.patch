From 70231626ac32ce0b45732b148ac46157302675cc Mon Sep 17 00:00:00 2001
From: Scott K Logan <logans@cottsay.net>
Date: Tue, 1 Dec 2015 02:45:17 -0800
Subject: [PATCH 1/6] ODROID-C: Fix null pointer dereference in ethernet code

---
 drivers/amlogic/efuse/efuse.c         | 28 +++++++++++++++++-----------
 drivers/amlogic/ethernet/am_net8218.c | 11 +++++++++--
 2 files changed, 26 insertions(+), 13 deletions(-)

diff --git a/drivers/amlogic/efuse/efuse.c b/drivers/amlogic/efuse/efuse.c
index a29a742..1d5fe67 100644
--- a/drivers/amlogic/efuse/efuse.c
+++ b/drivers/amlogic/efuse/efuse.c
@@ -242,19 +242,18 @@ static const struct file_operations efuse_fops = {
 #define MACCHAR(x)	(('A' <= (x) && (x) <= 'F') \
 				? (x) - 'A' + 'a' : (x))
 
-static char *aml_efuse_mac(void)
+static int aml_efuse_mac(unsigned char* hwmac)
 {
-	char hwmac[20];
 	char buf[80];
         char mac_mask;
 	efuseinfo_item_t info;
 
 	if (efuse_getinfo_byID(EFUSE_MAC_ID, &info) < 0)
-		return 0;
+		return -EINVAL;
 
 	if (efuse_read_item(buf, info.data_len,
 				(loff_t*)&info.offset) < 0)
-		return 0;
+		return -EINVAL;
 
 	sprintf(hwmac, "%02x:%02x:%02x:%02x:%02x:%02x",
 			buf[0], buf[1], buf[2], buf[3], buf[4], buf[5]);
@@ -276,12 +275,11 @@ static char *aml_efuse_mac(void)
                         MACCHAR(buf[14]), MACCHAR(buf[15]));
         }
 
-	return hwmac;
+	return 0;
 }
 
-unsigned char *aml_efuse_get_item(unsigned char* key_name)
+unsigned int aml_efuse_get_item(unsigned char* key_name, unsigned char* data)
 {
-        unsigned char *ret = 0;
 	int id;
 
         if(strcmp(key_name,"mac")==0)           id = EFUSE_MAC_ID;
@@ -290,21 +288,29 @@ unsigned char *aml_efuse_get_item(unsigned char* key_name)
         else if(strcmp(key_name,"usid")==0)     id = EFUSE_USID_ID;
         else {
                 pr_info("%s: UNKNOWN key_name\n",	__func__);
-		return 0;
+		return -EINVAL;
         }
 
 	if (id == EFUSE_MAC_ID) {
-		return aml_efuse_mac();
+		return aml_efuse_mac(data);
+	}
+	else
+	{
+		return -EINVAL;
 	}
 
-        return ret;
+        return 0;
 }
 EXPORT_SYMBOL(aml_efuse_get_item);
 
 /* Sysfs Files */
 static ssize_t mac_show(struct class *cla, struct class_attribute *attr, char *buf)
 {
-	return sprintf(buf, "%s\n", aml_efuse_mac());
+	unsigned char hwmac[20] = "00:00:00:00:00:00";
+
+	aml_efuse_mac(hwmac);
+
+	return sprintf(buf, "%s\n", hwmac);
 }
 
 static ssize_t mac_wifi_show(struct class *cla, struct class_attribute *attr, char *buf)
diff --git a/drivers/amlogic/ethernet/am_net8218.c b/drivers/amlogic/ethernet/am_net8218.c
index c39df30..ce3f20d 100644
--- a/drivers/amlogic/ethernet/am_net8218.c
+++ b/drivers/amlogic/ethernet/am_net8218.c
@@ -117,7 +117,7 @@ static int reset_mac(struct net_device *dev);
 static void am_net_dump_macreg(void);
 static void read_macreg(void);
 void hardware_reset_phy(void);
-extern char *aml_efuse_get_item(unsigned char* key_name);
+extern int aml_efuse_get_item(unsigned char* key_name, unsigned char* data);
 
 /* --------------------------------------------------------------------------*/
 /**
@@ -1352,9 +1352,16 @@ static void mac_from_efuse_to_DEFMAC(void)
 {
 	unsigned char mac[6];
 	unsigned char *efuse_mac;
+	unsigned char hwaddr[20];
 	int i;
 	
-	efuse_mac = aml_efuse_get_item("mac");
+	if (aml_efuse_get_item("mac", hwaddr) < 0)
+        {
+		return;
+        }
+
+	efuse_mac = hwaddr;
+
 	for (i = 0; i < 6 && efuse_mac[0] != '\0' && efuse_mac[1] != '\0'; i++) {
 		mac[i] = chartonum(efuse_mac[0]) << 4 | chartonum(efuse_mac[1]);
 		efuse_mac += 3;
-- 
2.1.0

