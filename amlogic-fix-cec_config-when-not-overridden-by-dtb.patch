From d73567831f993ff86a475a5af1697cb0059e1915 Mon Sep 17 00:00:00 2001
From: Scott K Logan <logans@cottsay.net>
Date: Sat, 25 Apr 2015 22:31:23 -0700
Subject: [PATCH] amlogic: Fix cec_config when not overridden by dtb

---
 arch/arm/boot/dts/meson8b_odroidc.dts      |  1 -
 arch/arm/mach-meson8b/pm.c                 |  9 ++-------
 drivers/amlogic/hdmi/hdmi_tx/hdmi_tx.c     | 15 ++++++++-------
 drivers/amlogic/hdmi/hdmi_tx/hdmi_tx_cec.c |  2 +-
 4 files changed, 11 insertions(+), 16 deletions(-)

diff --git a/arch/arm/boot/dts/meson8b_odroidc.dts b/arch/arm/boot/dts/meson8b_odroidc.dts
index efe382b..139b8aca 100755
--- a/arch/arm/boot/dts/meson8b_odroidc.dts
+++ b/arch/arm/boot/dts/meson8b_odroidc.dts
@@ -613,7 +613,6 @@
             vendor_id = <0x000000>;                 /* Refer to http://standards.ieee.org/develop/regauth/oui/oui.txt   */
             product_desc = "ODROID-C1";        /* Max Chars: 16    */
             cec_osd_string = "ODROID";        /* Max Chars: 14    */
-            cec_config = <0x00000f>;
             ao_cec = <0x000001>;
         };
 
diff --git a/arch/arm/mach-meson8b/pm.c b/arch/arm/mach-meson8b/pm.c
index 4fdd757..9c92b74 100755
--- a/arch/arm/mach-meson8b/pm.c
+++ b/arch/arm/mach-meson8b/pm.c
@@ -479,13 +479,8 @@ static int __init meson_pm_probe(struct platform_device *pdev)
 	clkxtal = clk_get_sys("xtal", NULL);
 	
 	cec_np = of_find_node_by_name(NULL, "vend_data");
-	if(cec_np){
-	    if(of_property_read_u32(cec_np, "cec_config", &cec_config))
-	        cec_config = 0x0;
-	}
-	else
-	{
-	    cec_config = 0x0;
+	if (!cec_np || of_property_read_u32(cec_np, "cec_config", &cec_config)) {
+	    cec_config = aml_read_reg32(P_AO_DEBUG_REG0);
 	}
     printk("hdmi: cec_pm: cec config:0x%x\n", cec_config);
     
diff --git a/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx.c b/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx.c
index 276fd41..931fc4a 100755
--- a/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx.c
+++ b/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx.c
@@ -1415,42 +1415,43 @@ EXPORT_SYMBOL(get_hdmitx_device);
 static int get_dt_vend_init_data(struct device_node *np, struct vendor_info_data *vend)
 {
     int ret;
+    int fail = 0;
 
     ret = of_property_read_string(np, "vendor_name", (const char **)&(vend->vendor_name));
     if(ret) {
         hdmi_print(INF, SYS "not find vendor name\n");
-        return 1;
+        fail = 1;
     }
 
     ret = of_property_read_u32(np, "vendor_id", &(vend->vendor_id));
     if(ret) {
         hdmi_print(INF, SYS "not find vendor id\n");
-        return 1;
+        fail = 1;
     }
 
     ret = of_property_read_string(np, "product_desc", (const char **)&(vend->product_desc));
     if(ret) {
         hdmi_print(INF, SYS "not find product desc\n");
-        return 1;
+        fail = 1;
     }
 
     ret = of_property_read_string(np, "cec_osd_string", (const char **)&(vend->cec_osd_string));
     if(ret) {
         hdmi_print(INF, SYS "not find cec osd string\n");
-        return 1;
+        fail = 1;
     }
     
     ret = of_property_read_u32(np, "cec_config", &(vend->cec_config));
     if(ret) {
         hdmi_print(INF, SYS "not find cec config\n");
-        return 1;
+        fail = 1;
     }
     ret = of_property_read_u32(np, "ao_cec", &(vend->ao_cec));
     if(ret) {
         hdmi_print(INF, SYS "not find ao cec\n");
-        return 1;
+        fail = 1;
     }
-    return 0;
+    return fail;
 }
 
 static int pwr_type_match(struct device_node *np, const char *str, int idx, struct hdmi_pwr_ctl *pwr, char* pwr_col)
diff --git a/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx_cec.c b/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx_cec.c
index 177876f..37e741b 100755
--- a/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx_cec.c
+++ b/drivers/amlogic/hdmi/hdmi_tx/hdmi_tx_cec.c
@@ -207,7 +207,7 @@ void cec_node_init(hdmitx_dev_t* hdmitx_device)
         aml_write_reg32(P_AO_DEBUG_REG0, vend_data->cec_config);
     }
     
-    hdmi_print(INF, CEC "cec_config: 0x%x; ao_cec:0x%x\n", vend_data->cec_config, vend_data->ao_cec);
+    hdmi_print(INF, CEC "cec_config: 0x%x; ao_cec:0x%x\n", hdmitx_device->cec_func_config, vend_data->ao_cec);
 
     if((vend_data) && (vend_data->cec_osd_string)) {
         i = strlen(vend_data->cec_osd_string);
-- 
2.1.0

